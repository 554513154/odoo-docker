#!/bin/bash
#
# This script is designed to be run inside the container
#

# fail hard and fast even on pipelines
set -eo pipefail

log_src='['${0##*/}']'

function help {
    set +e
    cat bin/help.txt
    set -e
}

function login  {
    echo $log_src[`date +%F.%H:%M:%S`]' Running bash'
    set +e
    if [[ ! -e $1 && $1 = "root" ]]; then
        /bin/bash
    else
        sudo su - odoo
    fi
    SERVICE_PID=$!
    set -e
}

function _update_odoo_conf_param {
    # If no value is provided, use default value
    val=$3
    if [ "$2" ]; then
        val=$2
    fi

    sudo -i -u $odoo_user sed -i "s/$1/$val/g" $odoo_conf_file
}

function _update_odoo_conf_params {
    echo $log_src[`date +%F.%H:%M:%S`]' Updating Odoo conf...'
    _update_odoo_conf_param '_ADMIN_PASSWORD_' "$ADMIN_PASSWORD" 'admin'
    _update_odoo_conf_param '_DB_USER_' "$DB_USER"
    _update_odoo_conf_param '_DB_PASSWORD_' "$DB_PASSWORD"
    _update_odoo_conf_param '_DB_FILTER_' "$DB_FILTER"
}

function _setup_ssh_key {
    echo $log_src[`date +%F.%H:%M:%S`]' Setting up SSH key...'
    ssh_folder=$( getent passwd $odoo_user | cut -d: -f6 )/.ssh
    echo $log_src[`date +%F.%H:%M:%S`]' Creating SSH folder = '$ssh_folder
    mkdir $ssh_folder
    echo $log_src[`date +%F.%H:%M:%S`]' Copy SSH private key from /opt/odoo/ssh'
    cp /opt/odoo/ssh/id_rsa $ssh_folder
    echo $log_src[`date +%F.%H:%M:%S`]' Scanning GitHub key...'
    ssh-keyscan github.com > $ssh_folder/known_hosts
    echo $log_src[`date +%F.%H:%M:%S`]' Setup SSH config...'
    echo "host github.com" > $ssh_folder/config
    echo "    HostName github.com" >> $ssh_folder/config
    echo "    User git" >> $ssh_folder/config
    echo "    IdentityFile $ssh_folder/id_rsa" >> $ssh_folder/config
    echo $log_src[`date +%F.%H:%M:%S`]' Securing SSH folder...'
    chown -R $odoo_user:$odoo_user $ssh_folder
    chmod 400 $ssh_folder/id_rsa
    echo $log_src[`date +%F.%H:%M:%S`]' Setup SSH key done'
}

function _download_addons {
    echo $log_src[`date +%F.%H:%M:%S`]' Check if need to download addons repo...'
    if [ "$ADDONS_REPO" -o -a /opt/odoo/additional_addons/oca_dependencies.txt ]; then
        echo $log_src[`date +%F.%H:%M:%S`]' Git config for target user'
        sudo -i -u $odoo_user git config --global user.email "contact@elico-corp.com"
        sudo -i -u $odoo_user git config --global user.name "Elico Corp - Odoo Docker"

        echo $log_src[`date +%F.%H:%M:%S`]' Checking if need to setup SSH key...'
        if [ -a /opt/odoo/ssh/id_rsa ]; then
            _setup_ssh_key
        fi

        if [[ -z "$FETCH_OCA_DEPENDENCIES" ]]; then
            echo $log_src[`date +%F.%H:%M:%S`]' Fetch dependencies undefined, set to True'
            FETCH_OCA_DEPENDENCIES=True
        fi

        echo $log_src[`date +%F.%H:%M:%S`]' Downloading additional addons...'
        sudo -i -u $odoo_user python /opt/odoo/auto_addons/addons.py $FETCH_OCA_DEPENDENCIES $ADDONS_REPO
    else
        echo $log_src[`date +%F.%H:%M:%S`]' No additional addons to download'
        sudo -i -u $odoo_user bash /opt/odoo/auto_addons/no_addons.sh $odoo_conf_file
    fi
}

function start {
    echo $log_src[`date +%F.%H:%M:%S`]' Checking special requirements...'
    bash /opt/scripts/startup.sh

    _update_odoo_conf_params
    _download_addons

    echo $log_src[`date +%F.%H:%M:%S`]' Running odoo...'
    set +e
    if [ ! -e $1 ]; then
        echo $log_src[`date +%F.%H:%M:%S`]' ...with additional args: ' $*
    fi
    sudo -i -u $odoo_user /usr/bin/python \
                    /opt/odoo/sources/odoo/openerp-server \
                    -c $odoo_conf_file \
                    $*

    SERVICE_PID=$!
    set -e
}

# smart shutdown on SIGINT and SIGTERM
function on_exit() {
    kill -TERM $SERVICE_PID
    wait $SERVICE_PID 2>/dev/null
    exit 0
}
trap on_exit INT TERM

echo $log_src[`date +%F.%H:%M:%S`]' Search for target Odoo user...'
bash /app/bin/target_user.sh
odoo_user=$( cat /tmp/odoo_user )

echo $log_src[`date +%F.%H:%M:%S`]' Search conf file...'
if [[ -z "$odoo_conf_file" ]]; then
    odoo_conf_file="/opt/odoo/etc/odoo.conf"
fi

echo $log_src[`date +%F.%H:%M:%S`]' Running command...'
for arg in "$*"
do
    $arg
done

wait